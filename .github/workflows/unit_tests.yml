name: Unit Tests
on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
  workflow_call:
permissions: write-all
env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
concurrency:
  group: unit-tests-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  test_ios:
    runs-on: self-hosted
    name: Execute Unit Tests
    strategy:
      matrix:
        collector: [CoreCollectorTests, BitmovinCollectorTests, AVFoundationCollectorTests, AmazonIVSPlayerCollectorTests]
      fail-fast: false
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/prepare-dependencies
      - name: Execute iOS Unit Tests for ${{ matrix.collector }}
        timeout-minutes: 10
        run: bundle exec fastlane test_collector "scheme:${{ matrix.collector }}"
      - name: Test Report
        uses: kishikawakatsumi/xcresulttool@v1
        if: success() || failure()
        with:
          title: iOS ${{ matrix.collector }} Unit Test Report
          path: fastlane/test_output/xctest/${{ matrix.collector }}.xcresult
          show-passed-tests: false
          upload-bundles: false
